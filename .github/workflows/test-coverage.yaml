# ğŸ“„ Datei: test-coverage.yaml
# ğŸ”§ Zweck: GitHub Actions Workflow fÃ¼r Testabdeckung
# ğŸ‘¤ Autor: MINT-RESEARCH
# ğŸ“… Erstellt: 2025-04-13
# ğŸ“˜ GÃ¼ltigkeit: required
# ğŸ§± Version: 1.0.0
# HINWEIS (MCP): Dieser Workflow fÃ¼hrt Tests aus und generiert Testabdeckungsberichte
# HINWEIS (MCP): fÃ¼r das MCP-Projekt. Er ist Teil der kontinuierlichen Compliance-Anforderungen.

name: Test Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest coverage
          # Install project dependencies
          if [ -f pyproject.toml ]; then
            pip install -e .
          else
            pip install pyyaml docker docker-compose
          fi
      
      - name: ğŸ§ª Run tests with coverage
        run: |
          python -m coverage run --source=mcp_units -m pytest tests/
      
      - name: ğŸ“Š Generate coverage report
        run: |
          python -m coverage report -m
          python -m coverage xml -o coverage.xml
      
      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
      
      - name: ğŸ“‹ Generate HTML coverage report
        run: |
          python -m coverage html --directory=coverage_html
      
      - name: ğŸ“¤ Upload coverage report as artifact
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage_html/
            coverage.xml
          retention-days: 14
      
      - name: ğŸ” Check coverage threshold
        run: |
          # Extract coverage percentage
          COVERAGE=$(python -m coverage report | grep TOTAL | awk '{print $NF}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          
          # Set minimum threshold (can be adjusted as coverage improves)
          THRESHOLD=50
          
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âš ï¸ Warning: Coverage is below the minimum threshold of $THRESHOLD%"
            echo "Consider adding more tests to improve coverage."
            # Uncomment the following line to fail the build if coverage is too low
            # exit 1
          else
            echo "âœ… Coverage meets the minimum threshold of $THRESHOLD%"
          fi